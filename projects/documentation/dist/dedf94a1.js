import"./d0c3fe1b.js";import{A as e}from"./589fbd1f.js";class t{constructor(e={}){this.warmUpDelay=1e3,this.coolDownDelay=1e3,this.isWarm=!1,this.cooldownTimeout=0,this.timeout=0,Object.assign(this,e)}async openTimer(e){if(this.cancelCooldownTimer(),this.component&&e.isSameNode(this.component)){if(this.promise)return this.promise;throw new Error("Inconsistent state")}return this.component&&(this.close(this.component),this.cancelCooldownTimer()),this.component=e,!this.isWarm&&(this.promise=new Promise(e=>{this.resolve=e,this.timeout=window.setTimeout(()=>{this.resolve&&(this.resolve(!1),this.isWarm=!0)},this.warmUpDelay)}),this.promise)}close(e){this.component&&this.component.isSameNode(e)&&(this.resetCooldownTimer(),this.timeout>0&&(clearTimeout(this.timeout),this.timeout=0),this.resolve&&(this.resolve(!0),delete this.resolve),delete this.promise,delete this.component)}resetCooldownTimer(){this.isWarm&&(this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),this.cooldownTimeout=window.setTimeout(()=>{this.isWarm=!1,delete this.cooldownTimeout},this.coolDownDelay))}cancelCooldownTimer(){this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),delete this.cooldownTimeout}}class o{constructor(e,t,o){this.isOpen=!1,this.owner=e,this.overlayElement=o,this.interaction=t}static async open(e,t,i,n){const s=new o(e,t,i);return await s.open(n),()=>{s.close()}}static update(){const e=new CustomEvent("sp-update-overlays",{bubbles:!0,composed:!0,cancelable:!0});document.dispatchEvent(e)}async open({delayed:e,offset:t=0,placement:i="top",receivesFocus:n}){if(this.isOpen)return!0;void 0===e&&(e=this.overlayElement.hasAttribute("delayed"));const s={color:void 0,scale:void 0},r=new CustomEvent("sp-query-theme",{bubbles:!0,composed:!0,detail:s,cancelable:!0});this.owner.dispatchEvent(r);const a={},l=new CustomEvent("sp-overlay-query",{bubbles:!0,composed:!0,detail:a,cancelable:!0});return this.overlayElement.dispatchEvent(l),await o.overlayStack.openOverlay(Object.assign({content:this.overlayElement,contentTip:a.overlayContentTipElement,delayed:e,offset:t,placement:i,trigger:this.owner,interaction:this.interaction,theme:s,receivesFocus:n},a)),this.isOpen=!0,!0}close(){o.overlayStack.closeOverlay(this.overlayElement)}}o.overlayStack=new class{constructor(){this.overlays=[],this.preventMouseRootClose=!1,this.root=document.body,this.handlingResize=!1,this.overlayTimer=new t,this.canTabTrap=!0,this.handleMouseCapture=e=>{const t=this.topOverlay;if(e.target&&t&&t.overlayContent&&!function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e)&&function(e){return 0===e.button}(e)){if(e.target instanceof Node){if(e.composedPath().indexOf(t.overlayContent)>=0)return void(this.preventMouseRootClose=!0);this.preventMouseRootClose=!1}}else this.preventMouseRootClose=!0},this.handleMouse=()=>{this.preventMouseRootClose||this.closeTopOverlay()},this.handleKeyUp=e=>{if("Escape"===e.code){const e=this.topOverlay;this.closeTopOverlay(),e&&e.trigger.focus()}},this.handleResize=()=>{this.handlingResize||(this.handlingResize=!0,requestAnimationFrame(async()=>{const e=this.overlays.map(e=>e.updateOverlayPosition());await Promise.all(e),this.handlingResize=!1}))},this.addEventListeners(),this.initTabTrapping()}initTabTrapping(){if(this.document.body.shadowRoot)return void(this.canTabTrap=!1);if(this.document.body.attachShadow({mode:"open"}),!this.document.body.shadowRoot)return;const e=this.document.body.shadowRoot;e.innerHTML='\n            <div id="actual"><slot></slot></div>\n            <style>\n            #actual {\n                position: relative;\n                height: 100%;\n                z-index: 0;\n                min-height: 100vh;\n            }\n            #holder {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                flex-flow: column;\n                height: 100%;\n                width: 100%;\n                top: 0;\n                left: 0;\n                position: fixed;\n            }\n            #holder[hidden] {\n                display: none !important;\n            }\n            #actual[tabindex="-1"] {\n                pointer-events: none;  /* just in case? */\n            }\n            </style>\n            <div id="holder" hidden><slot name="open"></slot></div>\n        ',this.tabTrapper=e.querySelector("#actual"),this.overlayHolder=e.querySelector("#holder"),this.tabTrapper.attachShadow({mode:"open"}),this.tabTrapper.shadowRoot&&(this.tabTrapper.shadowRoot.innerHTML="<slot></slot>")}startTabTrapping(){this.canTabTrap&&(this.tabTrapper.tabIndex=-1,this.overlayHolder.hidden=!1)}stopTabTrapping(){this.canTabTrap&&(this.tabTrapper.removeAttribute("tabindex"),this.overlayHolder.hidden=!0)}get document(){return this.root.ownerDocument||document}get topOverlay(){return this.overlays.slice(-1)[0]}findOverlayForContent(e){for(const t of this.overlays)if(e.isSameNode(t.overlayContent))return t}addEventListeners(){this.document.addEventListener("click",this.handleMouseCapture,!0),this.document.addEventListener("click",this.handleMouse),this.document.addEventListener("keyup",this.handleKeyUp),window.addEventListener("resize",this.handleResize)}isClickOverlayActiveForTrigger(e){return this.overlays.some(t=>e.isSameNode(t.trigger)&&"click"===t.interaction)}async openOverlay(t){if(this.findOverlayForContent(t.content))return!1;if("modal"===t.interaction&&this.startTabTrapping(),t.delayed){const e=this.overlayTimer.openTimer(t.content);if(await e)return e}if("click"===t.interaction)this.closeAllHoverOverlays();else if("hover"===t.interaction&&this.isClickOverlayActiveForTrigger(t.trigger))return!0;if(this.overlays.length){this.overlays[this.overlays.length-1].obscure()}const o=e.create(t);return document.body.appendChild(o),new Promise(e=>requestAnimationFrame(e)).then(async()=>(this.overlays.push(o),await o.updateComplete,this.addOverlayEventListeners(o),"auto"===t.receivesFocus&&o.focus(),!1))}addOverlayEventListeners(e){switch(e.addEventListener("close",()=>{this.hideAndCloseOverlay(e)}),e.interaction){case"replace":this.addReplaceOverlayEventListeners(e);break;case"inline":this.addInlineOverlayEventListeners(e)}}addReplaceOverlayEventListeners(e){e.addEventListener("keydown",t=>{const{code:o}=t;"Tab"===o&&(t.stopPropagation(),this.closeOverlay(e.overlayContent),e.tabbingAway=!0,e.trigger.focus(),e.trigger.dispatchEvent(new KeyboardEvent("keydown",t)))})}addInlineOverlayEventListeners(e){e.returnFocusElement||(e.returnFocusElement=document.createElement("span"),e.returnFocusElement.tabIndex=-1,e.trigger.hasAttribute("slot")&&(e.returnFocusElement.slot=e.trigger.slot),e.trigger.insertAdjacentElement("afterend",e.returnFocusElement)),e.trigger.addEventListener("keydown",e.handleInlineTriggerKeydown),e.addEventListener("keydown",t=>{const{code:o,shiftKey:i}=t;"Tab"===o&&(e.tabbingAway=!0,i&&e.returnFocusElement?e.returnFocusElement.focus():(t.stopPropagation(),this.closeOverlay(e.overlayContent),e.trigger.focus()))})}closeOverlay(e){this.overlayTimer.close(e),requestAnimationFrame(()=>{const t=this.findOverlayForContent(e);this.hideAndCloseOverlay(t)})}closeAllHoverOverlays(){for(const e of this.overlays)"hover"===e.interaction&&this.hideAndCloseOverlay(e,!1)}async hideAndCloseOverlay(e,t){if(e){if(await e.hide(t),"dispose"!=e.state)return;e.remove(),e.dispose();const o=this.overlays.indexOf(e);if(o>=0&&this.overlays.splice(o,1),this.overlays.length){const e=this.overlays[this.overlays.length-1];e.feature(),"modal"===e.interaction?e.focus():this.stopTabTrapping()}else this.stopTabTrapping(),"modal"!==e.interaction&&("replace"!==e.interaction&&"inline"!==e.interaction||e.tabbingAway)||e.trigger.focus(),e.tabbingAway=!1}}closeTopOverlay(){return this.hideAndCloseOverlay(this.topOverlay)}};export{o as Overlay};
//# sourceMappingURL=dedf94a1.js.map
